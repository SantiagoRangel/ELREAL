SELECT SYSDATE-(FECHA*30) AS TERMINA, SYSDATE-((FECHA*30)+30) AS EMPIEZA
FROM (SELECT * 
FROM ((SELECT SEGMENTO AS FECHA
FROM (SELECT SUM(COSTO) AS CUENTAIII, SEGMENTO
FROM (SELECT SEGMENTO, IDCONTRATO, COSTO 
FROM (SELECT ROWNUM AS SEGMENTO
FROM DUAL CONNECT BY ROWNUM <= (SELECT TRUNC(ANTIGUEDAD/30) 
FROM (SELECT TRUNC(SYSDATE-TO_DATE(FECHAINIC, 'YYYY-MM-DD'),0) AS ANTIGUEDAD
FROM CONTRATO
ORDER BY ANTIGUEDAD DESC)
WHERE ROWNUM = 1)) INNER JOIN (SELECT TRUNC(((SYSDATE-TO_DATE(FECHAINIC, 'YYYY-MM-DD'))/30),0) AS FIC, 
TRUNC(((SYSDATE-TO_DATE(FECHAFINAL, 'YYYY-MM-DD'))/30),0) AS FFC, IDCONTRATO, COSTO
FROM CONTRATO
WHERE IDHABITACION IS NOT NULL) ON FIC>= SEGMENTO AND FFC <= SEGMENTO)
GROUP BY SEGMENTO
ORDER BY CUENTAIII DESC)
WHERE ROWNUM = 1) UNION ALL
(SELECT SEGMENTO AS SEGMENTOMEJOR 
FROM (SELECT COUNT(IDCONTRATO) AS CUENTAI, SEGMENTO
FROM (SELECT SEGMENTO, IDCONTRATO 
FROM (SELECT ROWNUM AS SEGMENTO
FROM DUAL CONNECT BY ROWNUM <= (SELECT TRUNC(ANTIGUEDAD/30) 
FROM (SELECT TRUNC(SYSDATE-TO_DATE(FECHAINIC, 'YYYY-MM-DD'),0) AS ANTIGUEDAD
FROM CONTRATO
ORDER BY ANTIGUEDAD DESC)
WHERE ROWNUM = 1)) INNER JOIN (SELECT TRUNC(((SYSDATE-TO_DATE(FECHAINIC, 'YYYY-MM-DD'))/30),0) AS FIC, 
TRUNC(((SYSDATE-TO_DATE(FECHAFINAL, 'YYYY-MM-DD'))/30),0) AS FFC, IDCONTRATO
FROM CONTRATO
WHERE IDHABITACION IS NOT NULL) ON FIC>= SEGMENTO AND FFC <= SEGMENTO)
GROUP BY SEGMENTO
ORDER BY CUENTAI DESC)
WHERE ROWNUM = 1)) UNION ALL (SELECT SEGMENTO AS SEGMENTOPEOR
FROM (SELECT COUNT(IDCONTRATO) AS CUENTAII, SEGMENTO
FROM (SELECT SEGMENTO, IDCONTRATO 
FROM (SELECT ROWNUM AS SEGMENTO
FROM DUAL CONNECT BY ROWNUM <= (SELECT TRUNC(ANTIGUEDAD/30) 
FROM (SELECT TRUNC(SYSDATE-TO_DATE(FECHAINIC, 'YYYY-MM-DD'),0) AS ANTIGUEDAD
FROM CONTRATO
ORDER BY ANTIGUEDAD DESC)
WHERE ROWNUM = 1)) INNER JOIN (SELECT TRUNC(((SYSDATE-TO_DATE(FECHAINIC, 'YYYY-MM-DD'))/30),0) AS FIC, 
TRUNC(((SYSDATE-TO_DATE(FECHAFINAL, 'YYYY-MM-DD'))/30),0) AS FFC, IDCONTRATO
FROM CONTRATO
WHERE IDHABITACION IS NOT NULL) ON FIC>= SEGMENTO AND FFC <= SEGMENTO)
GROUP BY SEGMENTO
ORDER BY CUENTAII ASC)
WHERE ROWNUM = 1));
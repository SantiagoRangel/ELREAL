SELECT IDHABITACION, IDAPARTAMENTO, IDVIVIENDA, DISPONIBLE, DESCRIPCION, FECHAINICIAL, FECHAFINAL, IDOPERADOR, IDOFERTA 
FROM (SELECT * 
FROM OFERTA 
INNER JOIN (SELECT IDOFERTA AS IDO 
FROM (SELECT NVL(INDIC,0) AS INDICE, IDOFERTA 
FROM (SELECT SUM(NOCHES/TIEMPO) AS INDIC, IDOFERTA 
FROM (SELECT TIEMPO, IDOFERTA, NOCHES 
FROM ((SELECT (TO_DATE(OFERTA.FECHAFINAL,  'YYYY-MM-DD HH24:MI:SS') - TO_DATE(OFERTA.FECHAINICIAL,  'YYYY-MM-DD HH24:MI:SS')) AS TIEMPO, IDOFERTA, IDHABITACION AS HAB, IDAPARTAMENTO AS APT, IDVIVIENDA AS VIV 
FROM OFERTA)
LEFT OUTER JOIN CONTRATO ON NVL(HAB,0) = NVL(CONTRATO.IDHABITACION,0) AND NVL(APT,0) = NVL(CONTRATO.IDAPARTAMENTO,0) AND NVL(VIV,0) = NVL(CONTRATO.IDVIVIENDA,0))) 
GROUP BY IDOFERTA ORDER BY INDIC DESC)) 
WHERE ROWNUM <= 20 ORDER BY INDICE DESC) 
ON IDO = OFERTA.IDOFERTA);
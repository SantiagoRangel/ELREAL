SELECT  MONTO, NIGHTS, HABITACIONES, APARTAMENTOS, VIVIENDAS, USUARIO, NOMBRE
FROM (SELECT SUM(COSTO) AS MONTO, SUM(NOCHES) AS NIGHTS, IDCLIENTE, COUNT (DISTINCT HAB) AS HABITACIONES, COUNT(DISTINCT APT) AS APARTAMENTOS, COUNT(DISTINCT VIV) AS VIVIENDAS, USUARIO, NOMBRE
FROM (SELECT *
FROM (SELECT COSTO, NOCHES, IDCLIENTE, HAB, APT, VIV, IDOFERTA, USUARIO, NOMBRE, IDOPERADOR
FROM (SELECT *
FROM (SELECT COSTO, FFC, FIC, NOCHES, IDCLIENTE AS BOLEADOR, IDHC AS HAB, IDAC AS APT, IDVC AS VIV, IDOFERTA, IDOPERADOR
FROM (SELECT COSTO, FECHAFINAL AS FFC, FECHAINIC AS FIC, NOCHES, 
IDCLIENTE, NVL(IDHABITACION,0) AS IDHC, NVL(IDAPARTAMENTO,0) AS IDAC, NVL(IDVIVIENDA,0) AS IDVC
FROM CONTRATO
WHERE (TO_DATE('2900-01-01',  'YYYY-MM-DD') - TO_DATE(FECHAINIC,  'YYYY-MM-DD')) > 0
AND (TO_DATE(FECHAFINAL,  'YYYY-MM-DD') - TO_DATE('1900-01-01',  'YYYY-MM-DD')) > 0)
INNER JOIN (SELECT NVL(IDHABITACION,0) AS IDHO, NVL(IDAPARTAMENTO,0) AS IDAO, NVL(IDVIVIENDA,0) AS IDVO, 
FECHAINICIAL AS FIO, FECHAFINAL AS FFO, IDOFERTA, IDOPERADOR
FROM OFERTA
WHERE (TO_DATE('2900-01-01',  'YYYY-MM-DD') - TO_DATE(FECHAINICIAL,  'YYYY-MM-DD')) > 0
AND (TO_DATE(FECHAFINAL,  'YYYY-MM-DD') - TO_DATE('1900-01-01',  'YYYY-MM-DD')) > 0
AND DISPONIBLE = 1)
ON TO_DATE(FFC,  'YYYY-MM-DD') - TO_DATE(FFO,  'YYYY-MM-DD')<=0
AND TO_DATE(FIC,  'YYYY-MM-DD') - TO_DATE(FIO,  'YYYY-MM-DD')>=0
AND IDHO=IDHC AND IDAO=IDAC AND IDVC= IDVO) INNER JOIN CLIENTE
ON BOLEADOR = CLIENTE.IDCLIENTE)) UNION (SELECT COSTO, NOCHES, IDCLIENTE, HAB, APT, VIV, IDOFERTA, USUARIO, NOMBRE, IDOPERADOR
FROM (SELECT *
FROM (SELECT COSTO, FFC, FIC, NOCHES, IDCLIENTE AS BOLEADOR, IDHC AS HAB, IDAC AS APT, IDVC AS VIV, IDOFERTA, IDOPERADOR
FROM (SELECT COSTO, FECHAFINAL AS FFC, FECHAINIC AS FIC, NOCHES, 
IDCLIENTE, NVL(IDHABITACION,0) AS IDHC, NVL(IDAPARTAMENTO,0) AS IDAC, NVL(IDVIVIENDA,0) AS IDVC
FROM CONTRATO
WHERE (TO_DATE('2900-01-01',  'YYYY-MM-DD') - TO_DATE(FECHAINIC,  'YYYY-MM-DD')) > 0
AND (TO_DATE(FECHAFINAL,  'YYYY-MM-DD') - TO_DATE('1900-01-01',  'YYYY-MM-DD')) > 0)
INNER JOIN (SELECT NVL(IDHABITACION,0) AS IDHO, NVL(IDAPARTAMENTO,0) AS IDAO, NVL(IDVIVIENDA,0) AS IDVO, 
FECHAINICIAL AS FIO, FECHAFINAL AS FFO, IDOFERTA, IDOPERADOR
FROM OFERTA
WHERE (TO_DATE('2900-01-01',  'YYYY-MM-DD') - TO_DATE(FECHAINICIAL,  'YYYY-MM-DD')) > 0
AND (TO_DATE(FECHAFINAL,  'YYYY-MM-DD') - TO_DATE('1900-01-01',  'YYYY-MM-DD')) > 0
AND DISPONIBLE = 1)
ON TO_DATE(FFC,  'YYYY-MM-DD') - TO_DATE(FFO,  'YYYY-MM-DD')<=0
AND TO_DATE(FIC,  'YYYY-MM-DD') - TO_DATE(FIO,  'YYYY-MM-DD')>=0
AND IDHO=IDHC AND IDAO=IDAC AND IDVC= IDVO) INNER JOIN CLIENTE
ON BOLEADOR = CLIENTE.IDCLIENTE)))
WHERE IDOPERADOR = 10001
GROUP BY IDCLIENTE, USUARIO, NOMBRE)
ORDER BY MONTO;

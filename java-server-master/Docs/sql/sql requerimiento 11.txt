SELECT IDCLIENTE, USUARIO, NOMBRE, SUM(COSTO) AS MONTO, SUM(NOCHES) AS NIGHTS, 
COUNT(HAB) AS HABItACIONES, COUNT(APT) AS APARTAMENTOS, COUNT(VIV) AS VIVIENDAS
FROM (SELECT IDCLIENTE, USUARIO, NOMBRE, COSTO, NOCHES, IDHABITACION AS HAB, IDVIVIENDA AS VIV, IDAPARTAMENTO AS APT
FROM (SELECT IDCLIENTE AS CLI, USUARIO, CONTRASENA, NOMBRE
FROM CLIENTE
WHERE CLIENTE.IDCLIENTE NOT IN (SELECT IDCLIENTE
FROM (SELECT IDHABITACION AS IDHO, IDAPARTAMENTO AS IDAO, IDVIVIENDA AS IDVO, FECHAINICIAL AS FIO, FECHAFINAL AS FFO, IDOFERTA
FROM OFERTA
WHERE IDOFERTA = 50001) 
INNER JOIN CONTRATO ON NVL(IDHO,0) = NVL(CONTRATO.IDHABITACION,0) AND 
NVL(IDAO,0) = NVL(CONTRATO.IDAPARTAMENTO,0) AND
NVL(IDVO,0) = NVL(CONTRATO.IDVIVIENDA,0)
AND TO_DATE(CONTRATO.FECHAINIC, 'YYYY-MM-DD')-TO_DATE(FIO, 'YYYY-MM-DD')>=0
AND TO_DATE(CONTRATO.FECHAFINAL, 'YYYY-MM-DD')-TO_DATE(FFO, 'YYYY-MM-DD')<=0
AND TO_DATE(CONTRATO.FECHAINIC, 'YYYY-MM-DD')-TO_DATE('2017-01-01', 'YYYY-MM-DD')>=0
AND TO_DATE(CONTRATO.FECHAFINAL, 'YYYY-MM-DD')-TO_DATE('2018-02-05', 'YYYY-MM-DD')<=0)) 
INNER JOIN CONTRATO ON CONTRATO.IDCLIENTE = CLI
WHERE IDOPERADOR = 10003)
GROUP BY IDCLIENTE, USUARIO, NOMBRE
ORDER BY MONTO;